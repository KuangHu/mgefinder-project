# MGEfinder Pipeline Status
# Last updated: 2026-02-08

## Current Status: BATCH1 RE-EXTRACTED WITH NEW EXTRACTOR + BATCH2 DOWNLOADS IN PROGRESS

### Directory Structure:
```
/global/scratch/users/kh36969/
├── mgefinder_batch1/    # Batch 1: ~10K samples (COMPLETE through IS extraction v2)
│   ├── samples/         # 9,869 sample directories
│   ├── reference_genomes/
│   ├── scripts/
│   ├── jobs/
│   └── is_extraction_results/   # Combined summary TSV
│
├── mgefinder_batch2/    # Batch 2: 100K samples (DOWNLOADS IN PROGRESS)
│   ├── samples/         # 92,043 sample directories (assembly + reference only)
│   ├── reference_genomes -> mgefinder_batch1/reference_genomes  (symlink)
│   └── jobs/
│
└── mgefinder_project/   # Python modules + scripts (home dir)
    ├── is_extractor/    # IS element extractor v0.3.0 + Prodigal annotation
    ├── download_manager/
    ├── scripts/         # Pipeline scripts + PIPELINE.md guide
    └── STATUS.txt       # This file
```

### Git Repository:
- Remote: git@github.com:KuangHu/mgefinder-project.git
- Latest commit: daab658 (Fix IS extractor to use assembly contigs for flanking regions)

---

## BATCH 1 (~10K samples) — COMPLETE

### Completed Steps:
1. Reference genome downloads - DONE (2,277 genomes)
2. Sample downloads - DONE (9,869 samples)
3. Prepare (BWA + BAM) - DONE (9,283 BAM files)
4. MGEfinder analysis - DONE (7,510 samples with IS elements)
5. IS Extraction + Prodigal Annotation - RE-EXTRACTED with v0.3.0 (job 21060833, 38 min)
   - 7,506 samples processed, 0 failures
   - 1,271,773 IS elements extracted
   - 4,010,998 ORFs predicted by Prodigal
   - Flanking regions now from ASSEMBLY CONTIGS (not reference genome)
   - Strand auto-detected, flanking in IS reading frame
   - Verified on 20 random samples: 0 contiguity failures, 0 tiling failures
   - Per-sample JSON: samples/{SAMPLE}/is_extraction/is_elements.json
   - Summary TSV: is_extraction_results/is_elements_summary.tsv
6. IS Circle Detection - DONE (jobs 20973373-20973380)

### IS Element Dictionary Structure (per element):
```
is_id, sample, seqid, cluster, group, confidence
├── is_element:          sequence, length, contig, start, end, strand, method
├── flanking_upstream:   sequence, length, contig_start, contig_end, contig
│                        (from assembly contig, in IS reading frame)
├── flanking_downstream: sequence, length, contig_start, contig_end, contig
│                        (from assembly contig, in IS reading frame)
├── insertion_site:      contig, pos_5p, pos_3p (reference genome coords)
└── orf_annotation:
    ├── num_orfs, coding_fraction, total_coding_bp, total_noncoding_bp
    ├── orfs[]:          orf_id, start, end, strand, dna_sequence, protein_sequence
    └── noncoding_regions[]: start, end, length, type, sequence
```

Flanking regions: upstream_flank → IS_element → downstream_flank are contiguous on
the same assembly contig. IS elements detected only via inferred_database or
inferred_reference have empty flanking (no contiguous assembly representation).

### Verification Script:
```bash
# Verify a single sample
python scripts/verify_is_extraction.py /path/to/samples/SAMEA1234567

# Live test (run extractor + verify, no JSON needed)
python scripts/verify_is_extraction.py --live /path/to/samples/SAMEA1234567 -v

# Batch verify
python scripts/verify_is_extraction.py --batch /path/to/samples --max-samples 50
```

---

## BATCH 2 (100K samples) — IN PROGRESS

### Current Status:
- 92,043 samples have assembly + reference downloaded
- FASTQ reads download: IN PROGRESS (100 array jobs submitted, parts 1-33+ progressing)

### Download Jobs:
- Jobs 20999889-20999987: parts 1-97
- Jobs 21003277-21003278: parts 98-99
- Job 21023938: part 100

### What Each Sample Has:
| Component   | Count  | Status          |
|-------------|--------|-----------------|
| Assembly    | 92,039 | Done            |
| Reference   | 92,047 | Done            |
| Reads/FASTQ | ~30K+  | Downloading now |

---

## NEXT STEPS (in order):

### 1. Monitor batch2 downloads
```bash
squeue -u kh36969 | grep dl_batch | wc -l
find /global/scratch/users/kh36969/mgefinder_batch2/samples -maxdepth 3 -name "*_R1.fastq.gz" | wc -l
```

### 2. Run Prepare (BWA + BAM) for batch2
```bash
bash scripts/prepare_samples.sh /global/scratch/users/kh36969/mgefinder_batch2
```

### 3. Run MGEfinder for batch2
```bash
bash scripts/run_mgefinder.sh /global/scratch/users/kh36969/mgefinder_batch2
```

### 4. Run IS Extraction for batch2
```bash
bash scripts/run_is_extraction.sh /global/scratch/users/kh36969/mgefinder_batch2
```

### 5. Run IS Circle Detection for batch2
```bash
bash scripts/detect_circularized_is.sh /global/scratch/users/kh36969/mgefinder_batch2
```

### 6. Archive batch1 results
```bash
bash scripts/archive_batch.sh /global/scratch/users/kh36969/mgefinder_batch1
```

All steps are idempotent — safe to rerun after partial failures.
See scripts/PIPELINE.md for full documentation.

---

## Code Changes (2026-02-08):
- extractor.py v0.3.0: Flanking from assembly contigs with strand detection
  (was: reference genome flanking, no strand info)
- Added verify_is_extraction.py: contiguity + ORF tiling validation
- Removed annotate.py (duplicate of orf_finder.py), test_extractor.py (obsolete)
- Removed cleanup_circlemap.sh (one-off script)
- Updated PIPELINE.md with new Step 4 documentation

## Notes:
- B-PPI is a SEPARATE project at /global/home/users/kh36969/BPPI_project/
- Old stuck job 20707841_285 in CG state can be ignored
- Reference genomes in batch2 are a symlink to batch1's reference_genomes dir
- Sample registry at ~/mgefinder_project/sample_registry.tsv (104,493 samples: 10K batch1 + 94.5K batch2)
